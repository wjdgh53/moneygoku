// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Strategy defines trading logic and parameters
model Strategy {
  id              String   @id @default(cuid())
  name            String
  description     String?
  timeHorizon     TimeHorizon   @default(SWING)      // íˆ¬ì ê¸°ê°„
  riskAppetite    RiskAppetite  @default(BALANCED)   // ë¦¬ìŠ¤í¬ ì„±í–¥
  entryConditions Json     // Indicators and conditions for entry
  exitConditions  Json     // Indicators and conditions for exit
  stopLoss        Float    @default(5.0)    // 5% ì†ì ˆ
  takeProfit      Float    @default(10.0)   // 10% ìµì ˆ
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  bots            Bot[]
  backtests       BacktestRun[]

  @@map("strategies")
}

// Bot represents strategy + symbol combination
model Bot {
  id             String   @id @default(cuid())
  strategyId     String
  name           String
  symbol         String
  underlyingAsset String?  // ë ˆë²„ë¦¬ì§€ ETFì˜ ê¸°ì´ˆ ìì‚° (ì˜ˆ: BITX â†’ BTC)
  extendedHours  Boolean  @default(false)  // ì‹œê°„ì™¸ ê±°ë˜ í™œì„±í™” (pre-market, after-hours)
  status         BotStatus @default(STOPPED) // ACTIVE, PAUSED, STOPPED, ERROR
  mode           TradingMode @default(PAPER)  // PAPERë§Œ ì§€ì›
  orderType      String   @default("MARKET")  // MARKET, LIMIT
  fundAllocation Float    @default(1000.0)   // í• ë‹¹ ìê¸ˆ
  totalReturns   Float    @default(0.0)      // ì´ ìˆ˜ìµ (ì‹¤í˜„ ì†ìµ)
  realizedCash   Float    @default(0.0)      // ë§¤ë„ë¡œ íšŒìˆ˜í•œ í˜„ê¸ˆ
  winRate        Float    @default(0.0)      // ìŠ¹ë¥  %
  totalTrades    Int      @default(0)        // ì´ ê±°ë˜ ìˆ˜
  lastExecutedAt DateTime?
  analystRating  String?  // JSON: ì• ë„ë¦¬ìŠ¤íŠ¸ ë ˆì´íŒ… ë°ì´í„° (FMP)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relationships
  strategy       Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  trades         Trade[]
  reports        Report[]
  positions      Position[] // ë´‡ë³„ í¬ì§€ì…˜

  @@index([strategyId])
  @@index([symbol])
  @@index([status])
  @@map("bots")
}

// Trade represents individual buy/sell transactions
model Trade {
  id            String      @id @default(cuid())
  botId         String
  symbol        String
  side          TradeSide   // BUY or SELL
  quantity      Float
  price         Float
  total         Float       // quantity * price
  status        TradeStatus @default(EXECUTED) // EXECUTED, FAILED
  reason        String?     // "RSI < 30" (ê±°ë˜ ì´ìœ )
  alpacaOrderId String?     // Alpaca Order ID for tracking fill status
  executedAt    DateTime    @default(now())
  createdAt     DateTime    @default(now())

  // Relationships
  bot           Bot         @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([symbol])
  @@index([executedAt])
  @@map("trades")
}

// Portfolio represents global portfolio state
model Portfolio {
  id                  String   @id @default(cuid())
  totalCash           Float    @default(10000.0)  // ì „ì²´ í˜„ê¸ˆ
  totalValue          Float    @default(10000.0)  // ì „ì²´ ìì‚° ê°€ì¹˜
  totalReturns        Float    @default(0.0)      // ì „ì²´ ìˆ˜ìµ
  totalReturnsPercent Float    @default(0.0)      // ì „ì²´ ìˆ˜ìµë¥ 
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())

  @@map("portfolios")
}

// Position represents bot-specific symbol holdings
model Position {
  id            String   @id @default(cuid())
  botId         String   // ë´‡ë³„ í¬ì§€ì…˜ ê´€ë¦¬
  symbol        String   // ì¢…ëª© ì‹¬ë³¼
  quantity      Float    // í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰
  avgEntryPrice Float    // í‰ê·  ì§„ì…ê°€
  totalCost     Float    // ì´ íˆ¬ìê¸ˆ (quantity * avgEntryPrice)
  marketValue   Float    @default(0.0) // í˜„ì¬ ì‹œì¥ê°€ì¹˜ (quantity * currentPrice)
  unrealizedPL  Float    @default(0.0) // ë¯¸ì‹¤í˜„ ì†ìµ (marketValue - totalCost)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  // Relationships
  bot           Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, symbol]) // ë´‡ë‹¹ ì¢…ëª©ë‹¹ í•˜ë‚˜ì˜ í¬ì§€ì…˜ë§Œ
  @@map("positions")
}

// MarketData stores market price information cache (Enhanced for backtesting)
model MarketData {
  id        String   @id @default(cuid())

  // Identification
  symbol    String
  interval  String   @default("daily") // "1min", "5min", "15min", "60min", "daily"
  timestamp DateTime // Bar start time (UTC)

  // OHLCV data
  open      Float    // ì‹œê°€
  high      Float    // ê³ ê°€
  low       Float    // ì €ê°€
  close     Float    // ì¢…ê°€
  volume    Float    // ê±°ë˜ëŸ‰

  // Data quality flags (for backtesting)
  isValidated Boolean  @default(false)  // Passed validation checks
  hasGap      Boolean  @default(false)  // Gap detected before this bar
  isAnomaly   Boolean  @default(false)  // Flagged as anomalous (spike, zero volume)

  // Metadata
  source    String   @default("ALPHA_VANTAGE")
  fetchedAt DateTime @default(now())   // When data was fetched from API
  createdAt DateTime @default(now())

  @@unique([symbol, interval, timestamp])
  @@index([symbol, interval])
  @@index([timestamp])
  @@index([isValidated])
  @@map("market_data")
}

// WatchList stores symbols to track for market data
model WatchList {
  id       String   @id @default(cuid())
  symbol   String   @unique  // "AAPL"
  name     String             // "Apple Inc."
  isActive Boolean  @default(true)
  addedAt  DateTime @default(now())

  @@map("watchlist")
}

// BotRecommendationReport stores AI-generated bot recommendations
model BotRecommendationReport {
  id                  String   @id @default(cuid())
  recommendations     String   // JSON stringified: BotRecommendation[]
  analysisNotes       String?  // AI analysis notes
  totalOpportunities  Int      // Number of opportunities analyzed
  filteredOTCCount    Int      @default(0)  // Number of OTC stocks filtered
  highConfidenceCount Int      // Number of high confidence recommendations
  timestamp           DateTime @default(now())
  createdAt           DateTime @default(now())

  @@index([timestamp])
  @@map("bot_recommendation_reports")
}

// Report represents bot test analysis results
model Report {
  id             String    @id @default(cuid())
  botId          String
  bot            Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  // ê¸°ë³¸ ì •ë³´
  symbol         String
  currentPrice   Float
  executionTime  Int       // ms
  timestamp      DateTime  @default(now())

  // ëª©í‘œê°€ ì •ë³´
  targetPrice       Float?
  stopLossPrice     Float?
  takeProfitPercent Float?
  stopLossPercent   Float?

  // ë‰´ìŠ¤ ë¶„ì„
  newsArticles   String?   // JSON stringified
  newsSummary    String?
  newsSentiment  Float?
  sentimentLabel String?

  // ğŸ†• FMP íŒŒì‹± ë°ì´í„° (ìš”ì•½)
  fmpParsedData  String?   // JSON stringified: ParsedFMPData

  // ğŸ†• ë°±í…ŒìŠ¤íŒ…ìš© ì ìˆ˜ ìƒì„¸ ë°ì´í„°
  technicalScore      Float?    // ê¸°ìˆ  ì§€í‘œ ì ìˆ˜ (0.5 or -0.5)
  baseScore           Float?    // ê°ê´€ì  ê¸°ì´ˆ ì ìˆ˜ (ë‰´ìŠ¤ 70% + ê¸°ìˆ  30%)
  gptAdjustment       Float?    // GPT ì¡°ì •ê°’ (Â±0.5)
  finalScore          Float?    // ìµœì¢… ì ìˆ˜ (baseScore + gptAdjustment)
  objectiveReasoning  String?   // ê°ê´€ì  ë¶„ì„ ì„¤ëª…
  aiReasoning         String?   // AI íŒë‹¨ ì„¤ëª…

  // AI ê²°ì •
  aiAction       String?   // BUY, SELL, HOLD
  aiReason       String?   // Deprecated - use aiReasoning
  aiLimitPrice   Float?
  aiQuantity     Int?

  // ìµœì¢… ê²°ì •
  decision       String    // BUY, SELL, HOLD
  decisionReason String

  // ê±°ë˜ ì‹¤í–‰ ê²°ê³¼
  tradeExecuted  Boolean   @default(false)
  tradeSuccess   Boolean?
  tradeOrderId   String?
  tradeMessage   String?
  tradeError     String?

  // ì „ëµ íŒŒë¼ë¯¸í„° ìŠ¤ëƒ…ìƒ·
  strategyParams String    // JSON stringified

  // API í˜¸ì¶œ ë‚´ì—­
  apiCalls       String    // JSON stringified

  // ì¡°ê±´ í‰ê°€ ê²°ê³¼
  conditions     String    // JSON stringified

  // ì˜¤ë¥˜
  error          String?

  createdAt      DateTime  @default(now())

  @@index([botId])
  @@index([timestamp])
  @@map("reports")
}

// ==================================================
// BACKTESTING SYSTEM MODELS
// ==================================================

// MarketDataStatus tracks completeness of historical data for backtesting
model MarketDataStatus {
  id              String   @id @default(cuid())
  symbol          String
  interval        String   // "daily", "1min", "5min", etc.
  startDate       DateTime // Earliest available bar
  endDate         DateTime // Latest available bar
  totalBars       Int      @default(0)
  missingBars     Int      @default(0)
  completeness    Float    @default(0.0) // Percentage (0-100)
  lastUpdated     DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@unique([symbol, interval])
  @@index([symbol])
  @@map("market_data_status")
}

// AlphaVantageApiLog tracks API usage for rate limiting
model AlphaVantageApiLog {
  id              String   @id @default(cuid())
  endpoint        String   // "TIME_SERIES_INTRADAY", "TIME_SERIES_DAILY", etc.
  symbol          String
  interval        String?  // For intraday calls
  status          String   // "SUCCESS", "RATE_LIMITED", "ERROR"
  responseTime    Int      // milliseconds
  errorMessage    String?
  timestamp       DateTime @default(now())

  @@index([timestamp])
  @@index([status])
  @@map("alphavantage_api_logs")
}

// BacktestRun represents a single backtest execution
model BacktestRun {
  id              String   @id @default(cuid())

  // Configuration
  strategyId      String
  strategy        Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  symbol          String
  timeHorizon     TimeHorizon

  // Time range
  startDate       DateTime  // Backtest period start (e.g., 2023-01-01)
  endDate         DateTime  // Backtest period end (e.g., 2025-01-01)

  // Initial parameters
  initialCash     Float     @default(10000.0)
  positionSizing  String    @default("FIXED_DOLLAR")  // FIXED_DOLLAR, FIXED_SHARES, PERCENT_EQUITY
  positionSize    Float     @default(1000.0)          // $1000 per trade

  // Execution parameters
  slippageModel   String    @default("PERCENTAGE")     // PERCENTAGE, FIXED_DOLLAR
  slippageBps     Int       @default(10)               // 10 basis points = 0.1%
  commissionPerTrade Float  @default(1.0)              // $1 per trade

  // Results (calculated after backtest)
  totalTrades     Int       @default(0)
  winningTrades   Int       @default(0)
  losingTrades    Int       @default(0)
  winRate         Float     @default(0.0)              // Percentage

  finalCash       Float?
  finalEquity     Float?
  totalReturn     Float?                               // Dollar amount
  totalReturnPct  Float?                               // Percentage

  // Risk metrics
  sharpeRatio     Float?
  sortinoRatio    Float?
  maxDrawdown     Float?                               // Percentage
  maxDrawdownDate DateTime?

  // Additional metrics
  avgWinPct       Float?                               // Average winning trade %
  avgLossPct      Float?                               // Average losing trade %
  profitFactor    Float?                               // Gross profit / Gross loss
  expectancy      Float?                               // Average $ per trade

  // Metadata
  status          BacktestStatus @default(PENDING)     // PENDING, RUNNING, COMPLETED, FAILED
  errorMessage    String?
  executionTime   Int?                                 // milliseconds
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  trades          BacktestTrade[]
  positions       BacktestPosition[]
  equityCurve     BacktestEquityCurve[]
  alerts          BacktestAlert[]

  @@index([strategyId])
  @@index([symbol])
  @@index([status])
  @@index([createdAt])
  @@map("backtest_runs")
}

// BacktestTrade records individual trade executions during backtest
model BacktestTrade {
  id              String   @id @default(cuid())
  backtestRunId   String
  backtestRun     BacktestRun @relation(fields: [backtestRunId], references: [id], onDelete: Cascade)

  // Trade details
  symbol          String
  side            TradeSide        // BUY or SELL
  quantity        Float

  // Pricing
  targetPrice     Float            // Signal price (close of bar)
  executedPrice   Float            // Actual execution price (with slippage)
  slippage        Float            // Dollar amount of slippage
  commission      Float            // Commission paid

  // Trade economics
  grossAmount     Float            // quantity * executedPrice
  netAmount       Float            // grossAmount Â± slippage Â± commission

  // Timing
  signalBar       DateTime         // Bar that generated the signal
  executionBar    DateTime         // Bar on which order was filled

  // Performance (for SELL orders only)
  entryPrice      Float?           // Average entry price of position
  realizedPL      Float?           // Realized P&L for this trade
  realizedPLPct   Float?           // Realized P&L percentage
  holdingPeriod   Int?             // Number of bars held

  // Signal metadata (from Report scoring system)
  entryReason     String?          // Entry signal description
  exitReason      String?          // Exit signal description
  technicalScore  Float?           // Technical indicator score at entry
  newsScore       Float?           // News sentiment score at entry
  aiScore         Float?           // GPT adjustment score
  finalScore      Float?           // Combined score

  // Metadata
  createdAt       DateTime @default(now())

  @@index([backtestRunId])
  @@index([signalBar])
  @@map("backtest_trades")
}

// BacktestPosition tracks open positions during backtest
model BacktestPosition {
  id              String   @id @default(cuid())
  backtestRunId   String
  backtestRun     BacktestRun @relation(fields: [backtestRunId], references: [id], onDelete: Cascade)

  // Position details
  symbol          String
  quantity        Float
  avgEntryPrice   Float
  totalCost       Float            // Total invested (including commissions)

  // Current state (updated on each bar)
  currentPrice    Float            // Latest bar close
  marketValue     Float            // quantity * currentPrice
  unrealizedPL    Float            // marketValue - totalCost
  unrealizedPLPct Float            // (unrealizedPL / totalCost) * 100

  // Timing
  entryBar        DateTime         // First buy bar
  lastUpdateBar   DateTime         // Last price update bar

  // Risk management
  highWaterMark   Float            // Highest unrealized P&L ever reached
  maxDrawdownPct  Float            // Worst drawdown from high water mark

  // Status
  isOpen          Boolean  @default(true)
  closedAt        DateTime?
  exitBar         DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([backtestRunId, symbol, isOpen])  // Only one open position per symbol
  @@index([backtestRunId])
  @@map("backtest_positions")
}

// BacktestEquityCurve records portfolio value snapshots at each bar
model BacktestEquityCurve {
  id              String   @id @default(cuid())
  backtestRunId   String
  backtestRun     BacktestRun @relation(fields: [backtestRunId], references: [id], onDelete: Cascade)

  // Snapshot at each bar
  timestamp       DateTime         // Bar timestamp

  // Portfolio state
  cash            Float            // Available cash
  stockValue      Float            // Market value of positions
  totalEquity     Float            // cash + stockValue

  // Running metrics
  cumulativeReturn Float           // (totalEquity - initialCash) / initialCash
  drawdown        Float            // Current drawdown from peak (%)

  // Trade count
  tradeCount      Int              // Total trades executed so far

  @@unique([backtestRunId, timestamp])
  @@index([backtestRunId])
  @@index([timestamp])
  @@map("backtest_equity_curve")
}

// BacktestAlert records performance degradation alerts
model BacktestAlert {
  id            String   @id @default(cuid())

  backtestRunId String
  backtestRun   BacktestRun @relation(fields: [backtestRunId], references: [id], onDelete: Cascade)

  // Alert details
  alertType     String   // WIN_RATE_DROP, MAX_DRAWDOWN_BREACH, SHARPE_DECLINE
  severity      String   // LOW, MEDIUM, HIGH
  message       String
  threshold     Float?   // Threshold value that triggered alert

  // Metadata
  dismissed     Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([backtestRunId])
  @@index([dismissed])
  @@map("backtest_alerts")
}

// ==================================================
// END BACKTESTING SYSTEM MODELS
// ==================================================


// Enums
enum BotStatus {
  ACTIVE
  PAUSED
  STOPPED
  ERROR
}

enum TradingMode {
  PAPER
}

enum TradeSide {
  BUY
  SELL
}

enum TradeStatus {
  EXECUTED
  FAILED
}

enum TimeHorizon {
  SHORT_TERM  // Day Trading
  SWING       // Swing Trading
  LONG_TERM   // Position Trading
}

enum RiskAppetite {
  DEFENSIVE   // Conservative
  BALANCED    // Moderate
  AGGRESSIVE  // Aggressive
}

enum BacktestStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}
