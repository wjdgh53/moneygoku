// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Strategy defines trading logic and parameters
model Strategy {
  id              String   @id @default(cuid())
  name            String
  description     String?
  timeHorizon     TimeHorizon   @default(SWING)      // íˆ¬ì ê¸°ê°„
  riskAppetite    RiskAppetite  @default(BALANCED)   // ë¦¬ìŠ¤í¬ ì„±í–¥
  entryConditions Json     // Indicators and conditions for entry
  exitConditions  Json     // Indicators and conditions for exit
  stopLoss        Float    @default(5.0)    // 5% ì†ì ˆ
  takeProfit      Float    @default(10.0)   // 10% ìµì ˆ
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relationships
  bots            Bot[]

  @@map("strategies")
}

// Bot represents strategy + symbol combination
model Bot {
  id             String   @id @default(cuid())
  strategyId     String
  name           String
  symbol         String
  status         BotStatus @default(STOPPED) // ACTIVE, PAUSED, STOPPED, ERROR
  mode           TradingMode @default(PAPER)  // PAPERë§Œ ì§€ì›
  orderType      String   @default("MARKET")  // MARKET, LIMIT
  fundAllocation Float    @default(1000.0)   // í• ë‹¹ ìê¸ˆ
  totalReturns   Float    @default(0.0)      // ì´ ìˆ˜ìµ (ì‹¤í˜„ ì†ìµ)
  realizedCash   Float    @default(0.0)      // ë§¤ë„ë¡œ íšŒìˆ˜í•œ í˜„ê¸ˆ
  winRate        Float    @default(0.0)      // ìŠ¹ë¥  %
  totalTrades    Int      @default(0)        // ì´ ê±°ë˜ ìˆ˜
  lastExecutedAt DateTime?
  analystRating  String?  // JSON: ì• ë„ë¦¬ìŠ¤íŠ¸ ë ˆì´íŒ… ë°ì´í„° (FMP)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relationships
  strategy       Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  trades         Trade[]
  reports        Report[]
  positions      Position[] // ë´‡ë³„ í¬ì§€ì…˜

  @@index([strategyId])
  @@index([symbol])
  @@index([status])
  @@map("bots")
}

// Trade represents individual buy/sell transactions
model Trade {
  id            String      @id @default(cuid())
  botId         String
  symbol        String
  side          TradeSide   // BUY or SELL
  quantity      Float
  price         Float
  total         Float       // quantity * price
  status        TradeStatus @default(EXECUTED) // EXECUTED, FAILED
  reason        String?     // "RSI < 30" (ê±°ë˜ ì´ìœ )
  alpacaOrderId String?     // Alpaca Order ID for tracking fill status
  executedAt    DateTime    @default(now())
  createdAt     DateTime    @default(now())

  // Relationships
  bot           Bot         @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([symbol])
  @@index([executedAt])
  @@map("trades")
}

// Portfolio represents global portfolio state
model Portfolio {
  id                  String   @id @default(cuid())
  totalCash           Float    @default(10000.0)  // ì „ì²´ í˜„ê¸ˆ
  totalValue          Float    @default(10000.0)  // ì „ì²´ ìì‚° ê°€ì¹˜
  totalReturns        Float    @default(0.0)      // ì „ì²´ ìˆ˜ìµ
  totalReturnsPercent Float    @default(0.0)      // ì „ì²´ ìˆ˜ìµë¥ 
  updatedAt           DateTime @updatedAt
  createdAt           DateTime @default(now())

  @@map("portfolios")
}

// Position represents bot-specific symbol holdings
model Position {
  id            String   @id @default(cuid())
  botId         String   // ë´‡ë³„ í¬ì§€ì…˜ ê´€ë¦¬
  symbol        String   // ì¢…ëª© ì‹¬ë³¼
  quantity      Float    // í˜„ì¬ ë³´ìœ  ìˆ˜ëŸ‰
  avgEntryPrice Float    // í‰ê·  ì§„ì…ê°€
  totalCost     Float    // ì´ íˆ¬ìê¸ˆ (quantity * avgEntryPrice)
  marketValue   Float    @default(0.0) // í˜„ì¬ ì‹œì¥ê°€ì¹˜ (quantity * currentPrice)
  unrealizedPL  Float    @default(0.0) // ë¯¸ì‹¤í˜„ ì†ìµ (marketValue - totalCost)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())

  // Relationships
  bot           Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, symbol]) // ë´‡ë‹¹ ì¢…ëª©ë‹¹ í•˜ë‚˜ì˜ í¬ì§€ì…˜ë§Œ
  @@map("positions")
}

// MarketData stores market price information cache
model MarketData {
  id        String   @id @default(cuid())
  symbol    String
  open      Float    // ì‹œê°€
  high      Float    // ê³ ê°€
  low       Float    // ì €ê°€
  close     Float    // ì¢…ê°€
  volume    Float    // ê±°ë˜ëŸ‰
  timestamp DateTime // ë°ì´í„° ì‹œê°„
  source    String   @default("ALPHA_VANTAGE")
  createdAt DateTime @default(now())

  @@unique([symbol, timestamp])
  @@index([symbol])
  @@map("market_data")
}

// WatchList stores symbols to track for market data
model WatchList {
  id       String   @id @default(cuid())
  symbol   String   @unique  // "AAPL"
  name     String             // "Apple Inc."
  isActive Boolean  @default(true)
  addedAt  DateTime @default(now())

  @@map("watchlist")
}

// Report represents bot test analysis results
model Report {
  id             String    @id @default(cuid())
  botId          String
  bot            Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  // ê¸°ë³¸ ì •ë³´
  symbol         String
  currentPrice   Float
  executionTime  Int       // ms
  timestamp      DateTime  @default(now())

  // ëª©í‘œê°€ ì •ë³´
  targetPrice       Float?
  stopLossPrice     Float?
  takeProfitPercent Float?
  stopLossPercent   Float?

  // ë‰´ìŠ¤ ë¶„ì„
  newsArticles   String?   // JSON stringified
  newsSummary    String?
  newsSentiment  Float?
  sentimentLabel String?

  // ğŸ†• FMP íŒŒì‹± ë°ì´í„° (ìš”ì•½)
  fmpParsedData  String?   // JSON stringified: ParsedFMPData

  // ğŸ†• ë°±í…ŒìŠ¤íŒ…ìš© ì ìˆ˜ ìƒì„¸ ë°ì´í„°
  technicalScore      Float?    // ê¸°ìˆ  ì§€í‘œ ì ìˆ˜ (0.5 or -0.5)
  baseScore           Float?    // ê°ê´€ì  ê¸°ì´ˆ ì ìˆ˜ (ë‰´ìŠ¤ 70% + ê¸°ìˆ  30%)
  gptAdjustment       Float?    // GPT ì¡°ì •ê°’ (Â±0.5)
  finalScore          Float?    // ìµœì¢… ì ìˆ˜ (baseScore + gptAdjustment)
  objectiveReasoning  String?   // ê°ê´€ì  ë¶„ì„ ì„¤ëª…
  aiReasoning         String?   // AI íŒë‹¨ ì„¤ëª…

  // AI ê²°ì •
  aiAction       String?   // BUY, SELL, HOLD
  aiReason       String?   // Deprecated - use aiReasoning
  aiLimitPrice   Float?
  aiQuantity     Int?

  // ìµœì¢… ê²°ì •
  decision       String    // BUY, SELL, HOLD
  decisionReason String

  // ê±°ë˜ ì‹¤í–‰ ê²°ê³¼
  tradeExecuted  Boolean   @default(false)
  tradeSuccess   Boolean?
  tradeOrderId   String?
  tradeMessage   String?
  tradeError     String?

  // ì „ëµ íŒŒë¼ë¯¸í„° ìŠ¤ëƒ…ìƒ·
  strategyParams String    // JSON stringified

  // API í˜¸ì¶œ ë‚´ì—­
  apiCalls       String    // JSON stringified

  // ì¡°ê±´ í‰ê°€ ê²°ê³¼
  conditions     String    // JSON stringified

  // ì˜¤ë¥˜
  error          String?

  createdAt      DateTime  @default(now())

  @@index([botId])
  @@index([timestamp])
  @@map("reports")
}


// Enums
enum BotStatus {
  ACTIVE
  PAUSED
  STOPPED
  ERROR
}

enum TradingMode {
  PAPER
}

enum TradeSide {
  BUY
  SELL
}

enum TradeStatus {
  EXECUTED
  FAILED
}

enum TimeHorizon {
  SHORT_TERM  // Day Trading
  SWING       // Swing Trading
  LONG_TERM   // Position Trading
}

enum RiskAppetite {
  DEFENSIVE   // Conservative
  BALANCED    // Moderate
  AGGRESSIVE  // Aggressive
}
